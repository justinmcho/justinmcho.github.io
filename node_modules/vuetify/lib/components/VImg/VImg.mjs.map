{"version":3,"sources":["../../../src/components/VImg/VImg.tsx"],"names":["VResponsive","intersect","makeTransitionProps","MaybeTransition","computed","defineComponent","h","nextTick","onBeforeMount","ref","vShow","watch","withDirectives","makeProps","SUPPORTS_INTERSECTION","useRender","name","directives","props","aspectRatio","String","Number","alt","cover","Boolean","eager","lazySrc","options","type","Object","default","root","undefined","rootMargin","threshold","position","sizes","src","srcset","emits","setup","emit","slots","currentSrc","image","state","naturalWidth","naturalHeight","normalisedSrc","aspect","value","init","isIntersecting","pollForSize","getSrc","lazyImg","Image","onLoad","onError","img","timeout","poll","imgHeight","imgWidth","complete","setTimeout","endsWith","startsWith","containClasses","__image","class","sources","transition","__preloadImage","__placeholder","placeholder","error","__error","additional","handler"],"mappings":"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","sourcesContent":["import './VImg.sass'\n\n// Components\nimport { VResponsive } from '@/components'\n\n// Directives\nimport intersect from '@/directives/intersect'\n\n// Composables\nimport { makeTransitionProps, MaybeTransition } from '@/composables/transition'\n\n// Utilities\nimport {\n  computed,\n  defineComponent,\n  h,\n  nextTick,\n  onBeforeMount,\n  ref,\n  vShow,\n  watch,\n  withDirectives,\n} from 'vue'\nimport {\n  makeProps,\n  SUPPORTS_INTERSECTION,\n  useRender,\n} from '@/util'\n\n// Types\nimport type { PropType } from 'vue'\n\n// not intended for public use, this is passed in by vuetify-loader\nexport interface srcObject {\n  src?: string\n  srcset?: string\n  lazySrc?: string\n  aspect: number\n}\n\nexport default defineComponent({\n  name: 'VImg',\n\n  directives: { intersect },\n\n  props: makeProps({\n    aspectRatio: [String, Number],\n    alt: String,\n    cover: Boolean,\n    eager: Boolean,\n    lazySrc: String,\n    options: {\n      type: Object as PropType<IntersectionObserverInit>,\n      // For more information on types, navigate to:\n      // https://developer.mozilla.org/en-US/docs/Web/API/Intersection_Observer_API\n      default: () => ({\n        root: undefined,\n        rootMargin: undefined,\n        threshold: undefined,\n      }),\n    },\n    position: {\n      type: String,\n      default: 'center center',\n    },\n    sizes: String,\n    src: {\n      type: [String, Object] as PropType<string | srcObject>,\n      default: '',\n    },\n    srcset: String,\n    ...makeTransitionProps(),\n  }),\n\n  emits: ['loadstart', 'load', 'error'],\n\n  setup (props, { emit, slots }) {\n    const currentSrc = ref('') // Set from srcset\n    const image = ref<HTMLImageElement>()\n    const state = ref<'idle' | 'loading' | 'loaded' | 'error'>('idle')\n    const naturalWidth = ref<number>()\n    const naturalHeight = ref<number>()\n\n    const normalisedSrc = computed<srcObject>(() => {\n      return props.src && typeof props.src === 'object'\n        ? {\n          src: props.src.src,\n          srcset: props.srcset || props.src.srcset,\n          lazySrc: props.lazySrc || props.src.lazySrc,\n          aspect: Number(props.aspectRatio || props.src.aspect),\n        } : {\n          src: props.src,\n          srcset: props.srcset,\n          lazySrc: props.lazySrc,\n          aspect: Number(props.aspectRatio || 0),\n        }\n    })\n    const aspectRatio = computed(() => {\n      return normalisedSrc.value.aspect || naturalWidth.value! / naturalHeight.value! || 0\n    })\n\n    watch(() => props.src, () => {\n      init(state.value !== 'idle')\n    })\n    // TODO: getSrc when window width changes\n\n    onBeforeMount(() => init())\n\n    function init (isIntersecting?: boolean) {\n      // If the current browser supports the intersection\n      // observer api, the image is not observable, and\n      // the eager prop isn't being used, do not load\n      if (\n        SUPPORTS_INTERSECTION &&\n        !isIntersecting &&\n        !props.eager\n      ) return\n\n      state.value = 'loading'\n      nextTick(() => {\n        emit('loadstart', image.value?.currentSrc || normalisedSrc.value.src)\n        if (!aspectRatio.value) pollForSize(image.value!)\n        getSrc()\n      })\n\n      if (normalisedSrc.value.lazySrc) {\n        const lazyImg = new Image()\n        lazyImg.src = normalisedSrc.value.lazySrc\n        pollForSize(lazyImg, null)\n      }\n    }\n\n    function onLoad () {\n      getSrc()\n      state.value = 'loaded'\n      emit('load', image.value?.currentSrc || normalisedSrc.value.src)\n    }\n\n    function onError () {\n      state.value = 'error'\n      emit('error', image.value?.currentSrc || normalisedSrc.value.src)\n    }\n\n    function getSrc () {\n      const img = image.value\n      if (img) currentSrc.value = img.currentSrc || img.src\n    }\n\n    function pollForSize (img: HTMLImageElement, timeout: number | null = 100) {\n      const poll = () => {\n        const { naturalHeight: imgHeight, naturalWidth: imgWidth } = img\n\n        if (imgHeight || imgWidth) {\n          naturalWidth.value = imgWidth\n          naturalHeight.value = imgHeight\n        } else if (!img.complete && state.value === 'loading' && timeout != null) {\n          setTimeout(poll, timeout)\n        } else if (img.currentSrc.endsWith('.svg') || img.currentSrc.startsWith('data:image/svg+xml')) {\n          naturalWidth.value = 1\n          naturalHeight.value = 1\n        }\n      }\n\n      poll()\n    }\n\n    const containClasses = computed(() => ({\n      'v-img__img--cover': props.cover,\n      'v-img__img--contain': !props.cover,\n    }))\n\n    const __image = computed(() => {\n      if (!normalisedSrc.value.src || state.value === 'idle') return\n\n      const img = h('img', {\n        class: ['v-img__img', containClasses.value],\n        src: normalisedSrc.value.src,\n        srcset: normalisedSrc.value.srcset,\n        sizes: props.sizes,\n        ref: image,\n        onLoad,\n        onError,\n      })\n\n      const sources = slots.sources?.()\n\n      return (\n        <MaybeTransition transition={ props.transition } appear>\n          {\n            withDirectives(\n              sources\n                ? <picture class=\"v-img__picture\">{ sources }{ img }</picture>\n                : img,\n              [[vShow, state.value === 'loaded']]\n            )\n          }\n        </MaybeTransition>\n      )\n    })\n\n    const __preloadImage = computed(() => (\n      <MaybeTransition transition={ props.transition }>\n        { normalisedSrc.value.lazySrc && state.value !== 'loaded' && (\n          <img\n            class={['v-img__img', 'v-img__img--preload', containClasses.value]}\n            src={ normalisedSrc.value.lazySrc }\n            alt=\"\"\n          />\n        )}\n      </MaybeTransition>\n    ))\n\n    const __placeholder = computed(() => {\n      if (!slots.placeholder) return\n\n      return (\n        <MaybeTransition transition={ props.transition } appear>\n          { (state.value === 'loading' || (state.value === 'error' && !slots.error)) &&\n          <div class=\"v-img__placeholder\">{ slots.placeholder() }</div>\n          }\n        </MaybeTransition>\n      )\n    })\n\n    const __error = computed(() => {\n      if (!slots.error) return\n\n      return (\n        <MaybeTransition transition={ props.transition } appear>\n          { state.value === 'error' &&\n            <div class=\"v-img__error\">{ slots.error() }</div>\n          }\n        </MaybeTransition>\n      )\n    })\n\n    useRender(() => (\n      <VResponsive\n        class=\"v-img\"\n        aspectRatio={ aspectRatio.value }\n        aria-label={ props.alt }\n        role={ props.alt ? 'img' : undefined }\n        v-intersect={[{\n          handler: init,\n          options: props.options,\n        }, null, ['once']]}\n        v-slots={{\n          additional: () => [__image.value, __preloadImage.value, __placeholder.value, __error.value],\n          default: slots.default,\n        }}\n      />\n    ))\n\n    return {\n      currentSrc,\n      image,\n      state,\n      naturalWidth,\n      naturalHeight,\n    }\n  },\n})\n"],"file":"VImg.mjs"}